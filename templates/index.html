<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Global Chat System</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        :root {
            --bg-color: #F2F4F8;
            --card-bg: #FFFFFF;
            --text-primary: #1A202C;
            --text-secondary: #4A5568;
            --text-muted: #718096;
            --border-color: #E2E8F0;
            --accent-color: #1d4ed8;
            --accent-hover: #1e40af;
            --success: #38A169;
            --danger: #E53E3E;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        body,
        html {
            height: 100%;
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-primary);
            overflow: hidden;
        }

        .dashboard-wrapper {
            display: flex;
            flex-direction: column;
            height: 100vh;
            padding: 20px;
            box-sizing: border-box;
            gap: 20px;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }

        h1 {
            font-size: 20px;
            font-weight: 700;
            margin: 0;
        }

        .status-badge {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            background: #E2E8F0;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .status-badge .dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #A0AEC0;
        }

        .status-badge.connected {
            background: #C6F6D5;
            color: #22543D;
        }

        .status-badge.connected .dot {
            background: #38A169;
        }

        .status-badge.disconnected {
            background: #FED7D7;
            color: #822727;
        }

        .status-badge.disconnected .dot {
            background: #E53E3E;
        }

        .main-layout {
            display: grid;
            grid-template-columns: 1fr 300px;
            grid-template-rows: 1fr 1fr;
            gap: 20px;
            flex-grow: 1;
            min-height: 0;
        }

        .panel {
            background: var(--card-bg);
            border-radius: 10px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .logs-panel {
            grid-column: 1;
            grid-row: 1;
        }

        .graph-panel {
            grid-column: 1;
            grid-row: 2;
        }

        .clients-panel {
            grid-column: 2;
            grid-row: 1 / span 2;
        }

        .panel-header {
            padding: 12px 15px;
            border-bottom: 1px solid var(--border-color);
            background: #F8FAFC;
        }

        .panel-header h2 {
            margin: 0;
            font-size: 11px;
            font-weight: 700;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .scroll-area {
            flex-grow: 1;
            overflow-y: auto;
            padding: 0;
        }

        .log-entry {
            padding: 10px 15px;
            border-bottom: 1px solid var(--border-color);
            font-size: 13px;
        }

        .log-time {
            color: var(--text-muted);
            font-family: monospace;
            margin-right: 8px;
        }

        .log-tag {
            padding: 2px 5px;
            border-radius: 3px;
            font-weight: 700;
            font-size: 10px;
            margin-right: 8px;
            text-transform: uppercase;
        }

        .tag-routing {
            background: #EBF8FF;
            color: #2B6CB0;
        }

        .tag-connect {
            background: #F0FFF4;
            color: #2F855A;
        }

        .tag-disconnect {
            background: #FFF5F5;
            color: #C53030;
        }

        .client-item {
            padding: 10px 15px;
            display: flex;
            align-items: center;
            gap: 10px;
            border-bottom: 1px solid var(--border-color);
        }

        .client-avatar {
            width: 28px;
            height: 28px;
            background: var(--accent-color);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 12px;
        }

        .client-name {
            font-weight: 600;
            font-size: 13px;
        }

        #network-graph {
            width: 100%;
            height: 100%;
        }

        .node circle {
            stroke: #fff;
            stroke-width: 2px;
        }

        .node text {
            font-size: 10px;
            font-weight: 600;
        }

        .link {
            stroke: #E2E8F0;
            stroke-opacity: 0.6;
            stroke-width: 2px;
        }

        .packet {
            fill: var(--accent-color);
        }

        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-thumb {
            background: #CBD5E0;
            border-radius: 3px;
        }
    </style>
</head>

<body>
    <div class="dashboard-wrapper">
        <header>
            <h1>Admin Dashboard</h1>
            <div id="status-badge" class="status-badge">
                <div class="dot"></div>
                <span id="status-text">Connecting...</span>
            </div>
        </header>

        <div class="main-layout">
            <div class="panel logs-panel">
                <div class="panel-header">
                    <h2>Routing Logs</h2>
                </div>
                <div class="scroll-area" id="logs"></div>
            </div>

            <div class="panel graph-panel">
                <div class="panel-header">
                    <h2>Network Topology</h2>
                </div>
                <div class="scroll-area" style="overflow: hidden;">
                    <svg id="network-graph"></svg>
                </div>
            </div>

            <div class="panel clients-panel">
                <div class="panel-header">
                    <h2>Active Clients</h2>
                </div>
                <div class="scroll-area" id="clients"></div>
            </div>
        </div>
    </div>

    <script>
        // --- DATA STATE ---
        let clients = [];
        const logsDiv = document.getElementById('logs');
        const clientsDiv = document.getElementById('clients');
        const statusBadge = document.getElementById('status-badge');
        const statusText = document.getElementById('status-text');

        // --- D3 GRAPH SETTINGS ---
        const svg = d3.select("#network-graph");
        let width = 800, height = 400; // Placeholders, updated on mount/resize
        const g = svg.append("g");

        const simulation = d3.forceSimulation()
            .force("link", d3.forceLink().id(d => d.id).distance(100))
            .force("charge", d3.forceManyBody().strength(-400))
            .force("center", d3.forceCenter(width / 2, height / 2));

        let nodes = [{ id: "SERVER", type: "server", x: width / 2, y: height / 2, fx: width / 2, fy: height / 2 }];
        let links = [];

        function updateGraph() {
            const container = document.querySelector('.graph-panel');
            if (container) {
                width = container.clientWidth;
                height = container.clientHeight - 40;
                svg.attr("width", width).attr("height", height);
                simulation.force("center", d3.forceCenter(width / 2, height / 2));
                nodes[0].fx = width / 2; nodes[0].fy = height / 2;
            }

            links = nodes.filter(n => n.id !== "SERVER").map(n => ({ source: n.id, target: "SERVER" }));

            const link = g.selectAll(".link").data(links, d => `${d.source}-${d.target}`);
            link.exit().remove();
            const linkEnter = link.enter().append("line").attr("class", "link");
            const allLinks = linkEnter.merge(link);

            const node = g.selectAll(".node").data(nodes, d => d.id);
            node.exit().remove();
            const nodeEnter = node.enter().append("g")
                .attr("class", "node")
                .call(d3.drag().on("start", dragstarted).on("drag", dragged).on("end", dragended));

            nodeEnter.append("circle")
                .attr("r", d => d.type === "server" ? 18 : 12)
                .attr("fill", d => d.type === "server" ? "#2D3748" : "var(--accent-color)");

            nodeEnter.append("text").attr("dy", 25).attr("text-anchor", "middle").text(d => d.id);
            const allNodes = nodeEnter.merge(node);

            simulation.nodes(nodes);
            simulation.force("link").links(links);
            simulation.alpha(1).restart();

            simulation.on("tick", () => {
                allLinks.attr("x1", d => d.source.x).attr("y1", d => d.source.y).attr("x2", d => d.target.x).attr("y2", d => d.target.y);
                allNodes.attr("transform", d => `translate(${d.x},${d.y})`);
            });
        }

        function dragstarted(event, d) { if (!event.active) simulation.alphaTarget(0.3).restart(); d.fx = d.x; d.fy = d.y; }
        function dragged(event, d) { d.fx = event.x; d.fy = event.y; }
        function dragended(event, d) { if (!event.active) simulation.alphaTarget(0); if (d.type !== "server") { d.fx = null; d.fy = null; } }

        function animateMessage(fromId, toId) {
            const fromNode = nodes.find(n => n.id === fromId);
            const serverNode = nodes.find(n => n.id === "SERVER");
            if (!fromNode || !serverNode) return;

            const packet = g.append("circle").attr("class", "packet").attr("r", 5).attr("cx", fromNode.x).attr("cy", fromNode.y);
            packet.transition().duration(500).attr("cx", serverNode.x).attr("cy", serverNode.y).on("end", () => {
                packet.remove();
                const targets = toId === "ALL" ? nodes.filter(n => n.id !== "SERVER" && n.id !== fromId) : nodes.filter(n => n.id === toId);
                targets.forEach(target => {
                    const p2 = g.append("circle").attr("class", "packet").attr("r", 5).attr("cx", serverNode.x).attr("cy", serverNode.y);
                    p2.transition().duration(500).attr("cx", target.x).attr("cy", target.y).on("end", () => {
                        p2.remove();
                        g.selectAll(".node").filter(n => n.id === target.id).select("circle")
                            .transition().duration(200).attr("r", 18).transition().duration(200).attr("r", 12);
                    });
                });
            });
        }

        function renderClients() {
            clientsDiv.innerHTML = clients.map(c => `<div class="client-item"><div class="client-avatar">${c.username.charAt(0).toUpperCase()}</div><span class="client-name">${c.username}</span></div>`).join('');
            const currentClientIds = clients.map(c => c.username);
            currentClientIds.forEach(id => { if (!nodes.some(n => n.id === id)) nodes.push({ id: id, type: "client" }); });
            nodes = nodes.filter(n => n.type === "server" || currentClientIds.includes(n.id));
            updateGraph();
        }

        function addLog(type, content) {
            const div = document.createElement('div'); div.className = 'log-entry';
            const now = new Date(); const timeStr = now.getHours().toString().padStart(2, '0') + ':' + now.getMinutes().toString().padStart(2, '0') + ':' + now.getSeconds().toString().padStart(2, '0');
            let tagClass = 'tag-routing', tagName = 'ROUTING';
            if (type === 'connect') { tagClass = 'tag-connect'; tagName = 'CONNECT'; }
            if (type === 'disconnect') { tagClass = 'tag-disconnect'; tagName = 'DISCONNECT'; }
            div.innerHTML = `<span class="log-time">[${timeStr}]</span><span class="log-tag ${tagClass}">${tagName}</span>${content}`;
            logsDiv.insertBefore(div, logsDiv.firstChild);
        }

        const eventSource = new EventSource('/api/stream');
        eventSource.onopen = () => { statusText.textContent = 'Connected'; statusBadge.classList.add('connected'); statusBadge.classList.remove('disconnected'); };
        eventSource.onmessage = (e) => {
            const event = JSON.parse(e.data); const d = event.data;
            if (event.type === 'routing') { addLog('routing', `<b>${d.emitter}</b> &rarr; <b>${d.receiver}</b> <span style="color:var(--text-muted)">(${d.message_type})</span>`); animateMessage(d.emitter, d.receiver); }
            else if (event.type === 'client_connected') { addLog('connect', `User <b>${d.username}</b> joined`); clients.push(d); renderClients(); }
            else if (event.type === 'client_disconnected') { addLog('disconnect', `User <b>${d.username}</b> left`); clients = clients.filter(c => c.username !== d.username); renderClients(); }
            else if (event.type === 'client_list') { clients = d; renderClients(); }
        };
        eventSource.onerror = () => { statusText.textContent = 'Disconnected'; statusBadge.classList.remove('connected'); statusBadge.classList.add('disconnected'); };

        fetch('/api/clients').then(r => r.json()).then(data => { clients = data; renderClients(); updateGraph(); });
        window.addEventListener('resize', updateGraph);
    </script>
</body>

</html>